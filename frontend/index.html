<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Resume Query + Viewer</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#666; --accent:#2b7be4;
      --pad:14px; --radius:10px;
    }
    body{
      font-family: Inter, Roboto, Arial, sans-serif;
      background:var(--bg);
      margin:20px;
      color:#111;
      max-width:1100px;
    }

    h1{margin:0 0 12px 0}
    .row{display:flex; gap:18px; align-items:flex-start;}
    .col{flex:1}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:var(--pad);
      box-shadow:0 6px 18px rgba(33,40,50,0.06);
      margin-bottom:18px;
    }

    input, button, select, textarea {
      width:100%;
      padding:10px;
      font-size:14px;
      border:1px solid #e2e6ef;
      border-radius:8px;
      box-sizing:border-box;
    }

    label{font-size:13px; color:var(--muted); margin-bottom:6px; display:block}
    small{color:var(--muted)}

    button.primary{
      background:var(--accent); color:#fff; border:0;
      padding:10px 14px; cursor:pointer; border-radius:8px;
    }
    button.ghost{
      background:transparent; color:var(--accent); border:1px solid #d7e6ff;
    }

    .results-list { margin-top:10px; }
    .result-item{
      border-left:4px solid #eef6ff;
      padding:10px; margin-bottom:10px; border-radius:8px;
    }
    .result-item b{display:block; margin-bottom:6px}
    .actions{margin-top:8px}
    .link-btn{color:var(--accent); cursor:pointer; text-decoration:underline; background:none;border:0;padding:0;font-size:13px}

    /* viewer */
    #viewer{min-height:120px}
    .section{margin-bottom:14px}
    .section h3{margin:0 0 8px 0}
    .kv{display:flex; gap:8px; margin-bottom:6px}
    .kv .k{width:160px;color:var(--muted)}
    pre { background:#fafafa; padding:12px; border-radius:8px; overflow:auto; white-space:pre-wrap; }
    ul.skills{padding-left:18px; margin:6px 0}
    .controls{display:flex; gap:8px; justify-content:flex-end; margin-bottom:8px}
    .small-muted{font-size:13px;color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>

  <h1>Resume Uploader · Search · Viewer</h1>

  <div class="row">
    <div class="col">
      <div class="card">
        <h2 style="margin-top:0">Upload Resume</h2>
        <label>Name</label>
        <input id="name" placeholder="John Doe">
        <label>Resume Type</label>
        <input id="rtype" placeholder="fresher / experienced">
        <label>Occupation</label>
        <input id="role" placeholder="devops, frontend, civil">
        <label>File</label>
        <input type="file" id="file">
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="primary" onclick="upload()">Upload</button>
          <button class="ghost" onclick="clearUpload()">Clear</button>
        </div>

        <pre id="uploadResult" class="small-muted" style="margin-top:10px"></pre>
      </div>

      <div class="card">
        <h2 style="margin-top:0">Search Resumes</h2>
        <label>Filter - Name</label>
        <input id="qname" placeholder="Name">
        <label>Filter - Resume Type</label>
        <input id="qrtype" placeholder="Resume Type">
        <label>Filter - Occupation</label>
        <input id="qrole" placeholder="Occupation">
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="primary" onclick="search()">Search</button>
          <button class="ghost" onclick="clearSearch()">Clear</button>
        </div>

        <div id="results" class="results-list" style="margin-top:12px"></div>

        <!-- ⏱ Query Execution Time -->
        <div id="queryTime" style="margin-top:6px;font-size:13px;color:#444"></div>

      </div>
    </div>

    <div class="col" style="min-width:420px;">
      <div class="card">
        <div class="controls">
          <div style="flex:1"><small class="small-muted">Document Viewer — shows structured JSON nicely</small></div>
          <div>
            <button class="ghost" id="toggleFullBtn" onclick="toggleFull()" disabled>Show Full JSON</button>
            <button class="ghost" id="downloadBtn" onclick="downloadJSON()" disabled>Download JSON</button>
          </div>
        </div>

        <div id="viewer">
          <div id="viewerEmpty" class="small-muted">Open a resume from search results to view details here.</div>
          <div id="viewerContent" class="hidden">
            <div id="basicDetails" class="section"></div>
            <div id="summary" class="section"></div>
            <div id="skills" class="section"></div>
            <div id="experience" class="section"></div>
            <div id="certifications" class="section"></div>
            <div id="fullDoc" class="section hidden">
              <h3>Full Document</h3>
              <pre id="fullDocPre"></pre>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
const BACKEND = "https://testapi.phylon.in";

// ---------------- Upload ----------------
async function upload(){
  const fileEl = document.getElementById("file");
  if(!fileEl.files || fileEl.files.length===0){
    alert("Choose a file first");
    return;
  }

  const fd = new FormData();
  fd.append("name", document.getElementById("name").value)
  fd.append("resumetype", document.getElementById("rtype").value)
  fd.append("occupation", document.getElementById("role").value)
  fd.append("file", fileEl.files[0])

  document.getElementById("uploadResult").innerText = "Uploading..."
  try{
    const res = await fetch(`${BACKEND}/ingest`, { method: "POST", body: fd });
    if(!res.ok){
      const txt = await res.text();
      document.getElementById("uploadResult").innerText = "Upload failed: " + txt;
      return;
    }
    const data = await res.json();
    document.getElementById("uploadResult").innerText = JSON.stringify(data, null, 2);
    prependResultToList(data);
  }catch(err){
    document.getElementById("uploadResult").innerText = "Upload error: " + err;
  }
}
function clearUpload(){
  document.getElementById("name").value = "";
  document.getElementById("rtype").value = "";
  document.getElementById("role").value = "";
  document.getElementById("file").value = "";
  document.getElementById("uploadResult").innerText = "";
}

// ---------------- Search with Stopwatch ----------------
async function search(){
  const name = document.getElementById("qname").value.trim();
  const resumetype = document.getElementById("qrtype").value.trim();
  const occupation = document.getElementById("qrole").value.trim();

  const body = new URLSearchParams();
  if(name) body.append("name", name);
  if(resumetype) body.append("resumetype", resumetype);
  if(occupation) body.append("occupation", occupation);

  // ⏳ Stopwatch start
  let start = performance.now();
  let timerBox = document.getElementById("queryTime");
  timerBox.innerHTML = "⏳ Searching...";
  
  let live = setInterval(()=>{
      let ms = performance.now() - start;
      timerBox.innerHTML = `⏳ Query Running: <b>${ms.toFixed(1)} ms</b>`;
  }, 60);

  const res = await fetch(`${BACKEND}/search`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: body.toString()
  });

  const data = await res.json();
  clearInterval(live);

  // ⏱ Final execution time
  let total = performance.now() - start;
  let color = total > 400 ? "red" : total > 200 ? "orange" : "green";

  timerBox.innerHTML = `⚡ Completed in <b style="color:${color}">${total.toFixed(1)} ms</b>`;

  renderResults(data);
}

function clearSearch(){
  document.getElementById("qname").value = "";
  document.getElementById("qrtype").value = "";
  document.getElementById("qrole").value = "";
  document.getElementById("results").innerHTML = "";
  document.getElementById("queryTime").innerHTML = "";
}

// ---------------- Results rendering ----------------
function renderResults(data){
  const div = document.getElementById("results");
  div.i
